<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendar Servi√ßo - AutoFix</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="Assets/Styles/Agendar/Agendar.css">
    <link rel="stylesheet" href="Assets/Styles/Agendar/Agendar.scss">
    <link rel="stylesheet" href="Assets/Styles/Agendar/Agendar.css.map">

  
    </style>
  </head>

   <body>
    <header class="cabecario_header">
      <div class="container_nagavegacao">
        <a href="index.html" class="logo">
          <i class="fas fa-car-alt"></i> AUTOFIX
        </a>
        <nav class="navegacao">
          <a href="index.html"><i class="fas fa-home"></i> P√°gina Inicial</a>
          <a href="meus-agendamentos.html"
            ><i class="fas fa-calendar-check"></i> Meus Agendamentos</a
          >
          <div id="user-area"></div>
        </nav>
      </div>
    </header>

    <main>
      <div class="form-container">
        <h1><i class="fas fa-calendar-plus"></i> Agendar Servi√ßo</h1>
        <p>Agende seu servi√ßo mec√¢nico de forma r√°pida e conveniente</p>

        <div class="etapa-indicador">
          <div class="etapa-ponto ativo" data-etapa="1">1</div>
          <div class="etapa-ponto" data-etapa="2">2</div>
          <div class="etapa-ponto" data-etapa="3">3</div>
          <div class="etapa-ponto" data-etapa="4">4</div>
        </div>

        <!-- Etapa 1 - Sele√ß√£o de Servi√ßos -->
        <div id="etapa1" class="etapa ativa">
          <div class="etapa-header">
            <h2><i class="fas fa-tools"></i> Selecione os Servi√ßos</h2>
            <p>Escolha os servi√ßos que seu ve√≠culo necessita</p>
          </div>

          <div class="servicos-container">
            <div class="servico-card" data-servico="revisao">
              <h3><i class="fas fa-oil-can"></i> Revis√£o Preventiva</h3>
              <p>
                Verifica√ß√£o completa do ve√≠culo com troca de √≥leo e filtros.
              </p>
              <div class="servico-preco">R$ 299,90</div>
              <span class="servico-tempo">2-3 horas</span>
            </div>

            <div class="servico-card" data-servico="freios">
              <h3><i class="fas fa-stop-circle"></i> Troca de Freios</h3>
              <p>Substitui√ß√£o de pastilhas e discos de freio.</p>
              <div class="servico-preco">R$ 189,90</div>
              <span class="servico-tempo">1-2 horas</span>
            </div>

            <div class="servico-card" data-servico="bateria">
              <h3>
                <i class="fas fa-battery-three-quarters"></i> Troca de Bateria
              </h3>
              <p>Substitui√ß√£o da bateria com teste do sistema el√©trico.</p>
              <div class="servico-preco">R$ 249,90</div>
              <span class="servico-tempo">30-45 min</span>
            </div>

            <div class="servico-card" data-servico="pneus">
              <h3><i class="fas fa-tire"></i> Alinhamento e Balanceamento</h3>
              <p>Alinhamento de dire√ß√£o e balanceamento de rodas.</p>
              <div class="servico-preco">R$ 159,90</div>
              <span class="servico-tempo">1 hora</span>
            </div>

            <div class="servico-card" data-servico="ar">
              <h3><i class="fas fa-wind"></i> Manuten√ß√£o de Ar Condicionado</h3>
              <p>Recarga de g√°s e limpeza do sistema de ar condicionado.</p>
              <div class="servico-preco">R$ 179,90</div>
              <span class="servico-tempo">1-1.5 horas</span>
            </div>

            <div class="servico-card" data-servico="diagnostico">
              <h3>
                <i class="fas fa-check-engine"></i> Diagn√≥stico Eletr√¥nico
              </h3>
              <p>Leitura de falhas e verifica√ß√£o de sistemas eletr√¥nicos.</p>
              <div class="servico-preco">R$ 129,90</div>
              <span class="servico-tempo">30-60 min</span>
            </div>
          </div>

          <div class="div-btn">
            <button type="button" class="btn-avancar" onclick="avancarEtapa(2)">
              Pr√≥xima Etapa <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Etapa 2 - Informa√ß√µes do Ve√≠culo -->
        <div id="etapa2" class="etapa">
          <div class="etapa-header">
            <h2><i class="fas fa-car"></i> Informa√ß√µes do Ve√≠culo</h2>
            <p>Informe os dados do ve√≠culo que receber√° os servi√ßos</p>
          </div>

          <div class="form-group dois-campos">
            <div class="campo">
              <label for="marca"><i class="fas fa-car-side"></i> Marca</label>
              <select id="marca" required>
                <option value="">Selecione a marca</option>
                <option value="chevrolet">Chevrolet</option>
                <option value="fiat">Fiat</option>
                <option value="ford">Ford</option>
                <option value="honda">Honda</option>
                <option value="hyundai">Hyundai</option>
                <option value="toyota">Toyota</option>
                <option value="volkswagen">Volkswagen</option>
              </select>
            </div>
            <div class="campo">
              <label for="modelo"><i class="fas fa-car-alt"></i> Modelo</label>
              <input
                type="text"
                id="modelo"
                required
                placeholder="Ex: Onix, Gol, Civic"
              />
            </div>
          </div>

          <div class="form-group dois-campos">
            <div class="campo">
              <label for="ano"><i class="fas fa-calendar-alt"></i> Ano</label>
              <input
                type="number"
                id="ano"
                min="1980"
                max="2025"
                required
                placeholder="Ex: 2020"
              />
            </div>
            <div class="campo">
              <label for="placa"
                ><i class="fas fa-id-card-alt"></i> Placa</label
              >
              <input
                type="text"
                id="placa"
                required
                placeholder="Ex: ABC1D23"
                style="text-transform: uppercase"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="observacoes"
              ><i class="fas fa-comment-alt"></i> Observa√ß√µes</label
            >
            <textarea
              id="observacoes"
              rows="3"
              placeholder="Alguma observa√ß√£o importante sobre o ve√≠culo?"
            ></textarea>
          </div>

          <div class="div-btn">
            <button type="button" class="btn-voltar" onclick="voltarEtapa(1)">
              <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button type="button" class="btn-avancar" onclick="avancarEtapa(3)">
              Pr√≥xima Etapa <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Etapa 3 - Data e Hor√°rio -->
        <div id="etapa3" class="etapa">
          <div class="etapa-header">
            <h2><i class="far fa-calendar-alt"></i> Data e Hor√°rio</h2>
            <p>Selecione quando deseja agendar seu servi√ßo</p>
          </div>

          <div class="form-group">
            <label for="data"
              ><i class="fas fa-calendar-day"></i> Selecione a Data</label
            >
            <input type="date" id="data" required />
          </div>

          <div class="form-group">
            <label><i class="fas fa-clock"></i> Hor√°rios Dispon√≠veis</label>
            <div class="horarios-container">
              <button type="button" class="horario-btn" data-horario="08:00">
                08:00
              </button>
              <button type="button" class="horario-btn" data-horario="09:00">
                09:00
              </button>
              <button type="button" class="horario-btn" data-horario="10:00">
                10:00
              </button>
              <button
                type="button"
                class="horario-btn indisponivel"
                data-horario="11:00"
              >
                11:00
              </button>
              <button type="button" class="horario-btn" data-horario="13:00">
                13:00
              </button>
              <button type="button" class="horario-btn" data-horario="14:00">
                14:00
              </button>
              <button type="button" class="horario-btn" data-horario="15:00">
                15:00
              </button>
              <button type="button" class="horario-btn" data-horario="16:00">
                16:00
              </button>
            </div>
            <div
              id="horario-selecionado"
              style="display: none; margin-top: 1rem; color: #28a745"
            >
              <i class="fas fa-check-circle"></i> Hor√°rio selecionado:
              <span id="horario-texto"></span>
            </div>
          </div>

          <div class="div-btn">
            <button type="button" class="btn-voltar" onclick="voltarEtapa(2)">
              <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button type="button" class="btn-avancar" onclick="avancarEtapa(4)">
              Pr√≥xima Etapa <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Etapa 4 - Confirma√ß√£o -->
        <div id="etapa4" class="etapa">
          <div class="etapa-header">
            <h2><i class="fas fa-check-circle"></i> Confirma√ß√£o</h2>
            <p>Revise as informa√ß√µes antes de confirmar seu agendamento</p>
          </div>

          <div class="resumo-agendamento">
            <h3><i class="fas fa-clipboard-list"></i> Resumo do Agendamento</h3>

            <div class="resumo-item">
              <span>Servi√ßos:</span>
              <span id="resumo-servicos"></span>
            </div>

            <div class="resumo-item">
              <span>Ve√≠culo:</span>
              <span id="resumo-veiculo"></span>
            </div>

            <div class="resumo-item">
              <span>Data e Hor√°rio:</span>
              <span id="resumo-data"></span>
            </div>

            <div class="resumo-total">
              Total a Pagar: <span id="total-final"></span>
            </div>
          </div>

          <div class="form-group">
            <input type="checkbox" id="confirmacao" required />
            <label for="confirmacao"
              >Confirmo que as informa√ß√µes est√£o corretas e concordo com os
              <a href="termos.html">Termos de Servi√ßo</a>.</label
            >
          </div>

          <div class="div-btn">
            <button type="button" class="btn-voltar" onclick="voltarEtapa(3)">
              <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button
              type="button"
              class="btn-finalizar"
              onclick="finalizarAgendamento()"
            >
              <i class="fas fa-check"></i> Confirmar Agendamento
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
      // Configura√ß√£o do Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyA4ek9mJ3RomY25W4uTq4M7AHy2Q3a24iU",
        authDomain: "projeto-ec888.firebaseapp.com",
        projectId: "projeto-ec888",
        storageBucket: "projeto-ec888.firebasestorage.app",
        messagingSenderId: "818995568430",
        appId: "1:818995568430:web:7b3b1c3465e1c815e324bf",
      };

      // Inicializar Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // Vari√°veis globais
      let currentUser = null;
      let agendamento = {
        servicos: [],
        veiculo: {},
        data: null,
        horario: null,
        status: "Pendente",
        observacoes: "",
        valorTotal: 0,
      };

      // Mapeamento de servi√ßos
      const servicosInfo = {
        revisao: { nome: "Revis√£o Preventiva", preco: 299.9 },
        freios: { nome: "Troca de Freios", preco: 189.9 },
        bateria: { nome: "Troca de Bateria", preco: 249.9 },
        pneus: { nome: "Alinhamento e Balanceamento", preco: 159.9 },
        ar: { nome: "Manuten√ß√£o de Ar Condicionado", preco: 179.9 },
        diagnostico: { nome: "Diagn√≥stico Eletr√¥nico", preco: 129.9 },
      };

      const marcasNomes = {
        chevrolet: "Chevrolet",
        fiat: "Fiat",
        ford: "Ford",
        honda: "Honda",
        hyundai: "Hyundai",
        toyota: "Toyota",
        volkswagen: "Volkswagen",
      };

      // Verificar autentica√ß√£o
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          carregarDadosUsuario();
        } else {
          mostrarNotificacao(
            "Voc√™ precisa estar logado para agendar servi√ßos",
            "erro"
          );
          setTimeout(() => {
            window.location.href = "index.html";
          }, 2000);
        }
      });

      function carregarDadosUsuario() {
        db.collection("users")
          .doc(currentUser.uid)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const userData = doc.data();
              const nomeUsuario =
                userData.dadosPessoais?.nome ||
                currentUser.displayName ||
                currentUser.email.split("@")[0];

              document.getElementById("user-area").innerHTML = `
                        <span style="color: white;">Ol√°, ${nomeUsuario}!</span>
                    `;
            }
          });
      }

      // Configurar data m√≠nima
      document.addEventListener("DOMContentLoaded", function () {
        const hoje = new Date();
        const amanha = new Date(hoje.getTime() + 86400000);
        document.getElementById("data").min = amanha
          .toISOString()
          .split("T")[0];

        // Sele√ß√£o de servi√ßos
        document.querySelectorAll(".servico-card").forEach((card) => {
          card.addEventListener("click", function () {
            this.classList.toggle("selecionado");
            const servico = this.getAttribute("data-servico");

            if (this.classList.contains("selecionado")) {
              if (!agendamento.servicos.includes(servico)) {
                agendamento.servicos.push(servico);
              }
            } else {
              agendamento.servicos = agendamento.servicos.filter(
                (s) => s !== servico
              );
            }
          });
        });

        // Sele√ß√£o de hor√°rio
        document
          .querySelectorAll(".horario-btn:not(.indisponivel)")
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              document.querySelectorAll(".horario-btn").forEach((b) => {
                b.classList.remove("selecionado");
              });

              this.classList.add("selecionado");
              const horarioSelecionado = this.getAttribute("data-horario");
              agendamento.horario = horarioSelecionado;

              const indicador = document.getElementById("horario-selecionado");
              const textoHorario = document.getElementById("horario-texto");
              indicador.style.display = "block";
              textoHorario.textContent = horarioSelecionado;
            });
          });
      });

      // Navega√ß√£o entre etapas
      function avancarEtapa(etapa) {
        if (etapa === 2 && agendamento.servicos.length === 0) {
          mostrarNotificacao(
            "Selecione pelo menos um servi√ßo para continuar",
            "erro"
          );
          return;
        }

        if (etapa === 3) {
          const marca = document.getElementById("marca").value;
          const modelo = document.getElementById("modelo").value;
          const ano = document.getElementById("ano").value;
          const placa = document.getElementById("placa").value;

          if (!marca || !modelo || !ano || !placa) {
            mostrarNotificacao(
              "Preencha todos os campos do ve√≠culo para continuar",
              "erro"
            );
            return;
          }

          agendamento.veiculo = { marca, modelo, ano, placa };
          agendamento.observacoes =
            document.getElementById("observacoes").value;
        }

        if (etapa === 4) {
          const data = document.getElementById("data").value;
          if (!data || !agendamento.horario) {
            mostrarNotificacao(
              "Selecione uma data e hor√°rio para continuar",
              "erro"
            );
            return;
          }

          agendamento.data = data;
          atualizarResumo();
        }

        mostrarEtapa(etapa);
      }

      function voltarEtapa(etapa) {
        mostrarEtapa(etapa);
      }

      function mostrarEtapa(etapa) {
        document
          .querySelectorAll(".etapa")
          .forEach((e) => e.classList.remove("ativa"));
        document.getElementById(`etapa${etapa}`).classList.add("ativa");

        document.querySelectorAll(".etapa-ponto").forEach((ponto) => {
          ponto.classList.remove("ativo");
          if (parseInt(ponto.getAttribute("data-etapa")) <= etapa) {
            ponto.classList.add("ativo");
          }
        });
      }

      function atualizarResumo() {
        // Servi√ßos
        const servicosNomes = agendamento.servicos
          .map((s) => servicosInfo[s]?.nome || s)
          .join(", ");
        document.getElementById("resumo-servicos").textContent = servicosNomes;

        // Ve√≠culo
        const marcaNome =
          marcasNomes[agendamento.veiculo.marca] || agendamento.veiculo.marca;
        document.getElementById(
          "resumo-veiculo"
        ).textContent = `${marcaNome} ${agendamento.veiculo.modelo} ${agendamento.veiculo.ano} - ${agendamento.veiculo.placa}`;

        // Data e hor√°rio
        const dataObj = new Date(agendamento.data);
        document.getElementById(
          "resumo-data"
        ).textContent = `${dataObj.toLocaleDateString("pt-BR")} √†s ${
          agendamento.horario
        }`;

        // Valor total
        let total = 0;
        agendamento.servicos.forEach((s) => {
          total += servicosInfo[s]?.preco || 0;
        });
        agendamento.valorTotal = total;

        document.getElementById("total-final").textContent = `R$ ${total
          .toFixed(2)
          .replace(".", ",")}`;
      }

      async function finalizarAgendamento() {
        if (!document.getElementById("confirmacao").checked) {
          mostrarNotificacao(
            "Confirme que as informa√ß√µes est√£o corretas para finalizar",
            "erro"
          );
          return;
        }

        try {
          // Buscar dados do usu√°rio
          const userDoc = await db.collection("users").doc(currentUser.uid).get();
          
          if (!userDoc.exists) {
            throw new Error("Dados do usu√°rio n√£o encontrados");
          }

          const userData = userDoc.data();
          
          // Gerar ID √∫nico para o agendamento
          const agendamentoId = db.collection("agendamentos").doc().id;

          // Completar dados do agendamento - AJUSTADO PARA SUA ESTRUTURA
          const agendamentoCompleto = {
            id: agendamentoId,
            usuarioId: currentUser.uid,
            usuarioNome: userData.dadosPessoais?.nomeCompleto || currentUser.displayName || currentUser.email,
            usuarioEmail: currentUser.email,
            usuarioTelefone: userData.dadosPessoais?.telefone || "",
            local: userData.endereco?.completo || "AutoFix - Oficina Principal",
            dataCriacao: new Date().toISOString(), // String ao inv√©s de Timestamp
            data: agendamento.data, // String da data
            horario: agendamento.horario, // String do hor√°rio
            servicos: agendamento.servicos, // Array de strings
            veiculo: [
              agendamento.veiculo.marca,
              agendamento.veiculo.modelo,
              agendamento.veiculo.ano.toString(),
              agendamento.veiculo.placa
            ], // Array ao inv√©s de objeto
            status: agendamento.status,
            observacoes: agendamento.observacoes,
            valorTotal: agendamento.valorTotal.toString(), // String ao inv√©s de number
          };

          console.log("Salvando agendamento:", agendamentoCompleto);

          // Salvar agendamento na cole√ß√£o
          await db.collection("agendamentos").doc(agendamentoId).set(agendamentoCompleto);

          console.log("Agendamento salvo com sucesso!");

          mostrarNotificacao("üéâ Agendamento confirmado com sucesso!", "sucesso");
          
          setTimeout(() => {
            window.location.href = "meus-agendamentos.html";
          }, 2000);

        } catch (error) {
          console.error("Erro ao salvar agendamento:", error);
          mostrarNotificacao(
            "Erro ao salvar agendamento. Tente novamente.",
            "erro"
          );
        }
      }

      function mostrarNotificacao(mensagem, tipo = "sucesso") {
        const notificacao = document.createElement("div");
        notificacao.className = `notificacao ${tipo}`;
        notificacao.innerHTML = mensagem;
        document.body.appendChild(notificacao);

        setTimeout(() => {
          notificacao.classList.add("fade-out");
          setTimeout(() => notificacao.remove(), 500);
        }, 3000);
      }
    </script>
  </body>
</html>
