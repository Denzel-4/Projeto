<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro - AutoFix</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="Assets/Styles/Cadastro/Cadastro.css" />
    <link rel="stylesheet" href="Assets/Styles/Cadastro/Cadastro.scss" />
  </head>

  <body>
    <header class="cabecario_header">
      <div class="container_nagavegacao">
        <a href="index.html" class="logo">
          <i class="fas fa-car-alt"></i> AUTOFIX
        </a>
        <nav class="navegacao">
          <a href="index.html"><i class="fas fa-home"></i> Página Inicial</a>
        </nav>
      </div>
    </header>

    <main>
      <div class="form-container">
        <div class="progress-bar">
          <div id="progresso" class="progresso"></div>
        </div>

        <form id="cadastroForm">
          <!-- Etapa 1 - Login com Google -->
          <div id="etapa1" class="etapa ativa">
            <div class="etapa-header">
              <h2><i class="fas fa-user-plus"></i> Cadastre-se</h2>
              <p>
                Junte-se à AutoFix e agende serviços mecânicos com facilidade
              </p>
            </div>

            <div class="social-login">
              <button
                type="button"
                class="btn-google"
                onclick="loginComGoogle()"
              >
                <img
                  src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIyLjU2IDEyLjI1QzIyLjU2IDExLjQ3IDIyLjQ5IDEwLjcyIDIyLjM2IDEwSDEyVjE0LjI2SDE3LjkyQzE3LjY2IDE1LjYgMTYuOTIgMTYuNzQgMTUuODQgMTcuNVYyMC4yNkgxOS4yOEMyMS4zNiAxOC40MyAyMi41NiAxNS42IDIyLjU2IDEyLjI1WiIgZmlsbD0iIzQyODVGNCIvPgo8cGF0aCBkPSJNMTIgMjJDMTUuMTEgMjIgMTcuNzYgMjAuOTIgMTkuMjggMTguOTlMMTUuODQgMTYuMjNDMTQuNzggMTYuOTMgMTMuNDcgMTcuMzMgMTIgMTcuMzNDOS4wNiAxNy4zMyA2LjU3IDE1LjQ4IDUuNjcgMTIuOTlIMi4xOFYxNS44M0MzLjY5IDE4LjgzIDcuNjEgMjIgMTIgMjJaIiBmaWxsPSIjMzRBODUzIi8+CjxwYXRoIGQ9Ik01LjY3IDEyLjk5QzUuNDUgMTIuMjkgNS4zMyAxMS41NSA1LjMzIDEwLjhDNS4zMyAxMC4wNSA1LjQ1IDkuMzEgNS42NyA4LjYxVjUuNzdIMi4xOEMxLjQzIDcuMjcgMSA4Ljk5IDEgMTAuOEMxIDEyLjYxIDEuNDMgMTQuMzMgMi4xOCAxNS44M0w1LjY3IDEyLjk5WiIgZmlsbD0iI0ZCQkMwNSIvPgo8cGF0aCBkPSJNMTIgNC4zM0MxMy42OCA0LjMzIDE1LjE2IDQuOTMgMTYuMzIgNi4wNUwxOS4zNiAzLjAxQzE3Ljc2IDEuNTMgMTUuMTEgMC42NyAxMiAwLjY3QzcuNjEgMC42NyAzLjY5IDMuODQgMi4xOCA2Ljg0TDUuNjcgOS42OEM2LjU3IDcuMTkgOS4wNiA0LjMzIDEyIDQuMzNaIiBmaWxsPSIjRUE0MzM1Ii8+Cjwvc3ZnPgo="
                  alt="Google"
                />
                <span>Continuar com Google</span>
              </button>
            </div>

            <div class="divisao">
              <span>ou</span>
            </div>

            <div class="form-group">
              <label for="email"><i class="fas fa-envelope"></i> E-mail</label>
              <input
                type="email"
                id="email"
                required
                placeholder="seu@email.com"
              />
            </div>

            <div class="form-group">
              <label for="senha"><i class="fas fa-lock"></i> Senha</label>
              <input
                type="password"
                id="senha"
                required
                placeholder="Mínimo 6 caracteres"
              />
            </div>

            <div class="beneficios-cadastro">
              <h3>Por que se cadastrar?</h3>
              <ul>
                <li>
                  <i class="fas fa-check-circle"></i> Agendamento rápido de
                  serviços
                </li>
                <li>
                  <i class="fas fa-check-circle"></i> Histórico completo de
                  manutenções
                </li>
                <li>
                  <i class="fas fa-check-circle"></i> Orçamentos transparentes
                </li>
                <li>
                  <i class="fas fa-check-circle"></i> Alertas de revisão
                  periódica
                </li>
                <li>
                  <i class="fas fa-check-circle"></i> Descontos exclusivos
                </li>
              </ul>
            </div>

            <div class="div-btn">
              <button
                type="button"
                class="btn-avancar"
                onclick="avancarEtapa(2)"
              >
                Próxima Etapa <i class="fas fa-arrow-right"></i>
              </button>
            </div>

            <div class="termos-condicoes">
              <p>
                Ao continuar, você concorda com nossos
                <a href="termos.html">Termos de Serviço</a> e
                <a href="politicas.html">Política de Privacidade</a>.
              </p>
            </div>
          </div>

          <!-- Etapa 2 - Dados Pessoais -->
          <div id="etapa2" class="etapa">
            <div class="etapa-header">
              <h2><i class="fas fa-user-edit"></i> Dados Pessoais</h2>
              <p>Preencha seus dados para personalizarmos sua experiência</p>
            </div>

            <div class="form-group dois-campos">
              <div class="campo">
                <label for="nome"><i class="fas fa-user"></i> Nome</label>
                <input type="text" id="nome" required placeholder="Seu nome" />
              </div>
              <div class="campo">
                <label for="sobrenome"
                  ><i class="fas fa-user"></i> Sobrenome</label
                >
                <input
                  type="text"
                  id="sobrenome"
                  required
                  placeholder="Seu sobrenome"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="cpf"><i class="fas fa-id-card"></i> CPF</label>
              <input
                type="text"
                id="cpf"
                required
                oninput="formatarCPF(this)"
                placeholder="000.000.000-00"
              />
            </div>

            <div class="form-group">
              <label for="nascimento"
                ><i class="fas fa-birthday-cake"></i> Data de Nascimento</label
              >
              <input type="date" id="nascimento" required />
            </div>

            <div class="form-group">
              <label for="telefone"
                ><i class="fas fa-phone"></i> Telefone</label
              >
              <input
                type="text"
                id="telefone"
                required
                oninput="formatarTelefone(this)"
                placeholder="(00) 00000-0000"
              />
            </div>

            <div class="div-btn">
              <button type="button" class="btn-voltar" onclick="voltarEtapa(1)">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <button
                type="button"
                class="btn-avancar"
                onclick="avancarEtapa(3)"
              >
                Próxima Etapa <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>

          <!-- Etapa 3 - Endereço -->
          <div id="etapa3" class="etapa">
            <div class="etapa-header">
              <h2><i class="fas fa-map-marker-alt"></i> Endereço</h2>
              <p>Informe seu endereço para agendarmos serviços com precisão</p>
            </div>

            <div class="form-group">
              <label for="cep"
                ><i class="fas fa-search-location"></i> CEP</label
              >
              <div class="cep-container">
                <input
                  type="text"
                  id="cep"
                  required
                  oninput="formatarCEP(this)"
                  placeholder="00000-000"
                />
                <button type="button" onclick="buscarCEP()">
                  <i class="fas fa-search"></i> Buscar
                </button>
                <i
                  id="cep-loading"
                  class="fas fa-spinner fa-spin"
                  style="display: none"
                ></i>
              </div>
            </div>

            <div class="form-group dois-campos">
              <div class="campo">
                <label for="logradouro"
                  ><i class="fas fa-road"></i> Logradouro</label
                >
                <input
                  type="text"
                  id="logradouro"
                  required
                  placeholder="Rua, Avenida, etc."
                />
              </div>
              <div class="campo">
                <label for="numero"
                  ><i class="fas fa-hashtag"></i> Número</label
                >
                <input type="text" id="numero" required placeholder="123" />
              </div>
            </div>

            <div class="form-group dois-campos">
              <div class="campo">
                <label for="bairro"
                  ><i class="fas fa-map-marked-alt"></i> Bairro</label
                >
                <input
                  type="text"
                  id="bairro"
                  required
                  placeholder="Seu bairro"
                />
              </div>
              <div class="campo">
                <label for="cidade"><i class="fas fa-city"></i> Cidade</label>
                <input
                  type="text"
                  id="cidade"
                  required
                  placeholder="Sua cidade"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="estado"><i class="fas fa-map-pin"></i> Estado</label>
              <input
                type="text"
                id="estado"
                required
                placeholder="UF"
                maxlength="2"
              />
            </div>

            <div class="div-btn">
              <button type="button" class="btn-voltar" onclick="voltarEtapa(2)">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <button
                type="button"
                class="btn-finalizar"
                onclick="finalizarCadastro()"
              >
                <i class="fas fa-check"></i> Finalizar Cadastro
              </button>
            </div>
          </div>
        </form>
      </div>
    </main>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
      // Configuração do Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyA4ek9mJ3RomY25W4uTq4M7AHy2Q3a24iU",
        authDomain: "projeto-ec888.firebaseapp.com",
        projectId: "projeto-ec888",
        storageBucket: "projeto-ec888.firebasestorage.app",
        messagingSenderId: "818995568430",
        appId: "1:818995568430:web:7b3b1c3465e1c815e324bf",
      };

      // Inicializar Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      let etapaAtual = 1;
      let dadosCadastro = {};

      // Funções de formatação
      function formatarCPF(input) {
        let value = input.value.replace(/\D/g, "");
        if (value.length > 11) value = value.substring(0, 11);

        if (value.length > 9) {
          value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        } else if (value.length > 6) {
          value = value.replace(/(\d{3})(\d{3})(\d{3})/, "$1.$2.$3");
        } else if (value.length > 3) {
          value = value.replace(/(\d{3})(\d{3})/, "$1.$2");
        }
        input.value = value;
      }

      function formatarTelefone(input) {
        let value = input.value.replace(/\D/g, "");
        if (value.length > 11) value = value.substring(0, 11);

        if (value.length > 10) {
          value = value.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
        } else if (value.length > 6) {
          value = value.replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3");
        } else if (value.length > 2) {
          value = value.replace(/(\d{2})(\d{4})/, "($1) $2");
        } else if (value.length > 0) {
          value = value.replace(/(\d{2})/, "($1)");
        }
        input.value = value;
      }

      function formatarCEP(input) {
        let value = input.value.replace(/\D/g, "");
        if (value.length > 8) value = value.substring(0, 8);

        if (value.length > 5) {
          value = value.replace(/(\d{5})(\d{3})/, "$1-$2");
        }
        input.value = value;
      }

      // Buscar CEP
      function buscarCEP() {
        let cep = document.getElementById("cep").value.replace(/\D/g, "");
        if (cep.length === 8) {
          document.getElementById("cep-loading").style.display = "inline-block";
          fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then((response) => response.json())
            .then((data) => {
              document.getElementById("cep-loading").style.display = "none";
              if (!data.erro) {
                document.getElementById("logradouro").value = data.logradouro;
                document.getElementById("bairro").value = data.bairro;
                document.getElementById("cidade").value = data.localidade;
                document.getElementById("estado").value = data.uf;
              } else {
                mostrarNotificacao("CEP não encontrado!", "erro");
              }
            })
            .catch(() => {
              document.getElementById("cep-loading").style.display = "none";
              mostrarNotificacao("Erro ao buscar CEP", "erro");
            });
        } else {
          mostrarNotificacao("Digite um CEP válido com 8 dígitos!", "erro");
        }
      }

      // Navegação entre etapas
      function avancarEtapa(etapa) {
        if (validarEtapaAtual()) {
          mostrarEtapa(etapa);
        }
      }

      function voltarEtapa(etapa) {
        mostrarEtapa(etapa);
      }

      function mostrarEtapa(etapa) {
        // Esconder todas as etapas
        document
          .querySelectorAll(".etapa")
          .forEach((e) => e.classList.remove("ativa"));

        // Mostrar etapa atual
        document.getElementById(`etapa${etapa}`).classList.add("ativa");

        // Atualizar progresso
        const progresso = (etapa / 3) * 100;
        document.getElementById("progresso").style.width = `${progresso}%`;

        etapaAtual = etapa;
      }

      function validarEtapaAtual() {
        if (etapaAtual === 1) {
          const email = document.getElementById("email").value;
          const senha = document.getElementById("senha").value;

          if (!email || !senha) {
            mostrarNotificacao("Preencha todos os campos obrigatórios", "erro");
            return false;
          }

          if (senha.length < 6) {
            mostrarNotificacao(
              "A senha deve ter pelo menos 6 caracteres",
              "erro"
            );
            return false;
          }

          dadosCadastro.email = email;
          dadosCadastro.senha = senha;
          return true;
        }

        if (etapaAtual === 2) {
          const nome = document.getElementById("nome").value;
          const sobrenome = document.getElementById("sobrenome").value;
          const cpf = document.getElementById("cpf").value;
          const nascimento = document.getElementById("nascimento").value;
          const telefone = document.getElementById("telefone").value;

          if (!nome || !sobrenome || !cpf || !nascimento || !telefone) {
            mostrarNotificacao("Preencha todos os campos obrigatórios", "erro");
            return false;
          }

          dadosCadastro.dadosPessoais = {
            nome,
            sobrenome,
            nomeCompleto: `${nome} ${sobrenome}`,
            cpf,
            dataNascimento: nascimento,
            telefone,
            dataCadastro: new Date(),
          };
          return true;
        }

        return true;
      }

      // Login com Google
      function loginComGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth
          .signInWithPopup(provider)
          .then((result) => {
            const user = result.user;
            // Verificar se o usuário já existe no Firestore
            return db.collection("users").doc(user.uid).get();
          })
          .then((doc) => {
            if (doc.exists) {
              // Usuário já existe, fazer login
              mostrarNotificacao("Login realizado com sucesso!", "sucesso");
              setTimeout(() => {
                window.location.href = "index.html";
              }, 1500);
            } else {
              // Novo usuário, continuar com cadastro
              dadosCadastro.googleUser = auth.currentUser;
              avancarEtapa(2);
            }
          })
          .catch((error) => {
            console.error("Erro no login com Google:", error);
            mostrarNotificacao("Erro no login com Google", "erro");
          });
      }

      // Finalizar cadastro
      function finalizarCadastro() {
        if (!validarEtapaAtual()) return;

        // Coletar dados do endereço
        const cep = document.getElementById("cep").value;
        const logradouro = document.getElementById("logradouro").value;
        const numero = document.getElementById("numero").value;
        const bairro = document.getElementById("bairro").value;
        const cidade = document.getElementById("cidade").value;
        const estado = document.getElementById("estado").value;

        if (!cep || !logradouro || !numero || !bairro || !cidade || !estado) {
          mostrarNotificacao("Preencha todos os campos de endereço", "erro");
          return;
        }

        dadosCadastro.endereco = {
          cep,
          logradouro,
          numero,
          bairro,
          cidade,
          estado,
          completo: `${logradouro}, ${numero}, ${bairro}, ${cidade} - ${estado}, ${cep}`,
        };

        // Criar conta ou salvar dados
        if (dadosCadastro.googleUser) {
          // Usuário logado com Google
          salvarDadosUsuario(dadosCadastro.googleUser.uid);
        } else {
          // Criar conta com email/senha
          auth
            .createUserWithEmailAndPassword(
              dadosCadastro.email,
              dadosCadastro.senha
            )
            .then((userCredential) => {
              const user = userCredential.user;
              return salvarDadosUsuario(user.uid);
            })
            .then(() => {
              mostrarNotificacao("Cadastro realizado com sucesso!", "sucesso");
              setTimeout(() => {
                window.location.href = "index.html";
              }, 2000);
            })
            .catch((error) => {
              console.error("Erro no cadastro:", error);
              mostrarNotificacao("Erro no cadastro: " + error.message, "erro");
            });
        }
      }

      function salvarDadosUsuario(uid) {
        const userData = {
          id: uid,
          email: dadosCadastro.email || dadosCadastro.googleUser.email,
          dadosPessoais: dadosCadastro.dadosPessoais,
          endereco: dadosCadastro.endereco,
          agendamentos: [],
          isAdmin: false,
          metadata: {
            cadastroCompleto: true,
            ultimaAtualizacao: new Date(),
          },
        };

        return db
          .collection("users")
          .doc(uid)
          .set(userData)
          .then(() => {
            mostrarNotificacao("Dados salvos com sucesso!", "sucesso");
            setTimeout(() => {
              window.location.href = "index.html";
            }, 2000);
          });
      }

      function mostrarNotificacao(mensagem, tipo = "sucesso") {
        const notificacao = document.createElement("div");
        notificacao.className = `notificacao ${tipo}`;
        notificacao.innerHTML = mensagem;
        document.body.appendChild(notificacao);

        setTimeout(() => {
          notificacao.classList.add("fade-out");
          setTimeout(() => notificacao.remove(), 500);
        }, 3000);
      }
    </script>
  </body>
</html>
